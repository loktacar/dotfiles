#!/bin/zsh

tmux start-server

PROJNAME=${@[$#]}
OPENPOSTGRE=""
ISPYTHON=false
DOUBLEWIDE=true

VIMWINDOW="edit"
POSTGREWINDOW="postgres"

TMUXVER=`tmux -V`

while getopts ':P:p:d:s' opt "$@"; do
  case $opt in
    P)
      OPENPOSTGRE=$OPTARG
      ;;
    p)
      ISPYTHON=true
      ;;
    d)
      DOUBLEWIDE=true
      ;;
    s)
      DOUBLEWIDE=false
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

if [[ $PROJNAME == $OPENPOSTGRE || $PROJNAME == "p" || $PROJNAME == "P" || $PROJNAME == "" ]]; then
  echo "-p for python workon"
  echo "-P [dbname] for db window"
  echo "Then gief project folder name under ~/Projects/"
fi


if ! $(tmux has-session -t $PROJNAME 2> /dev/null); then

  tmux new-session -d -s $PROJNAME -n $VIMWINDOW

  tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd ~/Projects/'$PROJNAME C-m

  if $ISPYTHON; then
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'workon '$PROJNAME C-m
  fi

  tmux send-keys -t $PROJNAME:$VIMWINDOW 'clear' C-m
  tmux split-window -h -t $PROJNAME:$VIMWINDOW

  # Test tmux version and resize
  if [[ $TMUXVER == "tmux 1.8" ]]; then
    if $DOUBLEWIDE ; then
      # Double wide
      tmux resize-pane -x 169
    else
      # Single wide
      tmux resize-pane -x 84
    fi
  else
    tmux resize-pane -R 10000 # Sets size to 2

    if $DOUBLEWIDE ; then
      # Double wide
      tmux resize-pane -L 167
    else
      # Single wide
      tmux resize-pane -L 82
    fi
  fi
  # tmux resize-pane -L 50


  tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd ~/Projects/'$PROJNAME C-m
  if $ISPYTHON; then
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'workon '$PROJNAME C-m
  fi
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'clear' C-m
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'vim' C-m

  if [[ ! -z "$OPENPOSTGRE" ]]; then
    tmux new-window -t $PROJNAME -n $POSTGREWINDOW
    tmux send-keys -t $PROJNAME:$POSTGREWINDOW 'clear' C-m
    tmux send-keys -t $PROJNAME:$POSTGREWINDOW 'psql '$OPENPOSTGRE' postgres' C-m
  fi

  tmux select-window -t $PROJNAME:$VIMWINDOW
fi

tmux -2 attach -t $PROJNAME
