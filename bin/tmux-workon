#!/bin/zsh

tmux start-server

PROJNAME=${@[$#]}
OPENPOSTGRE=""
ISPYTHON=false
ISRAILS=false
DOUBLEWIDE=true

VIMWINDOW="edit"
POSTGREWINDOW="postgres"

if [ -z "$PROJECTFOLDER" ]; then
  PROJFOLDER='~/projects'
fi

TMUXVER=`tmux -V`

#while getopts P:pds opt "$@"; do
#  case $opt in
#    r) ISRAILS=true ;;
#    P) OPENPOSTGRE=$OPTARG ;;
#    p) ISPYTHON=true ;;
#    d) DOUBLEWIDE=true ;;
#    s) DOUBLEWIDE=false ;;
#    :)
#      echo "Option -$OPTARG requires an argument." >&2
#      exit 1
#      ;;
#  esac
#done
set -- $(getopt rPpds: "$@")
while [ $# -gt 0 ]
do
  case "$1" in
    (-r) ISRAILS=true ;;
    (-P) OPENPOSTGRE=$2; shift ;;
    (-p) ISPYTHON=true ;;
    (-d) DOUBLEWIDE=true ;;
    (-s) DOUBLEWIDE=false ;;
    (--) shift; break;;
    (-*) echo "$0: error - unrecognized option $1" 1>&2; exit 1;;
    (*) break ;;
  esac
  shift
done

if [[ $PROJNAME == "p" || $PROJNAME == "P" || $PROJNAME == "" ]]; then
  echo "-p for python workon"
  echo "-P [dbname] for db window"
  echo "Then gief project folder name under $PROJFOLDER/"
fi


if ! $(tmux has-session -t $PROJNAME 2> /dev/null); then

  # Create sessions
  tmux new-session -d -s $PROJNAME -n $VIMWINDOW
  tmux set-option -g allow-rename off

  # Run commands on shell pane
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd '"$PROJFOLDER"'/'$PROJNAME C-m

  if $ISPYTHON; then
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'workon '$PROJNAME C-m
  fi

  if $ISRAILS; then
    tmux split-window -t $PROJNAME:$VIMWINDOW
    tmux resize-pane -y 10 -t $PROJNAME:$VIMWINDOW
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd '"$PROJFOLDER"'/'$PROJNAME C-m
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'bundle exec guard' C-m
    tmux split-window -h -t $PROJNAME:$VIMWINDOW
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd '"$PROJFOLDER"'/'$PROJNAME C-m
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'tailf -n 100 log/development.log' C-m
    tmux select-pane -t 0
  fi

  tmux send-keys -t $PROJNAME:$VIMWINDOW 'clear' C-m

  tmux split-window -h -t $PROJNAME:$VIMWINDOW
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd '"$PROJFOLDER"'/'$PROJNAME C-m

  tmux select-pane -l

  # Test tmux version and resize
  if [[ $TMUXVER == "tmux 1.8" ]]; then
    if $DOUBLEWIDE ; then
      # Double wide
      tmux resize-pane -x 169
    else
      # Single wide
      tmux resize-pane -x 84
    fi
  else
    tmux resize-pane -L 10000 # Sets size to 2

    if $DOUBLEWIDE ; then
      # Double wide
      tmux resize-pane -R 167
    else
      # Single wide
      tmux resize-pane -R 82
    fi
  fi

  tmux send-keys -t $PROJNAME:$VIMWINDOW 'vim' C-m

  tmux select-pane -l
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'cd '"$PROJFOLDER"'/'$PROJNAME C-m

  if $ISPYTHON; then
    tmux send-keys -t $PROJNAME:$VIMWINDOW 'workon '$PROJNAME C-m
  fi
  tmux send-keys -t $PROJNAME:$VIMWINDOW 'clear' C-m

  if [[ ! -z "$OPENPOSTGRE" ]]; then
    tmux new-window -t $PROJNAME -n $POSTGREWINDOW
    tmux set-option -g allow-rename off
    tmux send-keys -t $PROJNAME:$POSTGREWINDOW 'clear' C-m
    tmux send-keys -t $PROJNAME:$POSTGREWINDOW 'psql '$OPENPOSTGRE' postgres' C-m
  fi

  tmux select-window -t $PROJNAME:$VIMWINDOW
fi

tmux -2 attach -t $PROJNAME
